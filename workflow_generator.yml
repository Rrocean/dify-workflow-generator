# Dify Workflow Generator - Meta Workflow
# è¿™æ˜¯ä¸€ä¸ª"ç”Ÿæˆå·¥ä½œæµçš„å·¥ä½œæµ"ï¼Œå¯¼å…¥ Dify åå¯é€šè¿‡å¯¹è¯ç”Ÿæˆå…¶ä»–å·¥ä½œæµ
# DSL Version: 0.5.0

app:
  name: Difyå·¥ä½œæµç”Ÿæˆå™¨
  mode: advanced-chat
  icon: ğŸ¤–
  description: é€šè¿‡è‡ªç„¶è¯­è¨€æè¿°ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯å¯¼å…¥çš„ Dify å·¥ä½œæµ YAML
  use_icon_as_answer_icon: false

workflow:
  # ========== èŠ‚ç‚¹å®šä¹‰ ==========
  nodes:
    # ---- å¼€å§‹èŠ‚ç‚¹ ----
    - id: start
      type: start
      title: å¼€å§‹
      position:
        x: 80
        y: 300
      data:
        variables:
          - name: requirement
            type: string
            description: æè¿°ä½ æƒ³è¦åˆ›å»ºçš„å·¥ä½œæµï¼ˆå¦‚ï¼šä¸€ä¸ªç¿»è¯‘å·¥ä½œæµï¼Œè¾“å…¥æ–‡æœ¬å’Œç›®æ ‡è¯­è¨€ï¼‰
            required: true
          - name: workflow_name
            type: string
            description: å·¥ä½œæµåç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤è‡ªåŠ¨ç”Ÿæˆï¼‰
            required: false

    # ---- æ„å›¾åˆ†æèŠ‚ç‚¹ ----
    - id: intent_analysis
      type: llm
      title: æ„å›¾åˆ†æ
      position:
        x: 300
        y: 300
      data:
        model:
          provider: anthropic
          name: claude-3-5-sonnet-20241022
          mode: chat
          completion_params:
            temperature: 0.3
            max_tokens: 2000
        prompt_template:
          - role: system
            text: |
              ä½ æ˜¯ Dify å·¥ä½œæµåˆ†æä¸“å®¶ã€‚åˆ†æç”¨æˆ·çš„éœ€æ±‚ï¼Œæå–å…³é”®ä¿¡æ¯ã€‚

              è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š
              {
                "workflow_type": "å·¥ä½œæµç±»å‹",
                "input_variables": ["è¾“å…¥å˜é‡åˆ—è¡¨"],
                "output_format": "è¾“å‡ºæ ¼å¼",
                "key_nodes": ["éœ€è¦çš„èŠ‚ç‚¹ç±»å‹"],
                "complexity": "simple|medium|complex"
              }
          - role: user
            text: |
              åˆ†æä»¥ä¸‹å·¥ä½œæµéœ€æ±‚ï¼š

              {{#start.requirement#}}

              å·¥ä½œæµåç§°ï¼š{{#start.workflow_name#}}

              è¯·åˆ†æå¹¶è¿”å› JSON æ ¼å¼çš„åˆ†æç»“æœã€‚
        variables:
          - name: start.requirement
            value_selector: ["start", "requirement"]
          - name: start.workflow_name
            value_selector: ["start", "workflow_name"]

    # ---- æ¶æ„è®¾è®¡èŠ‚ç‚¹ ----
    - id: architecture_design
      type: llm
      title: æ¶æ„è®¾è®¡
      position:
        x: 550
        y: 200
      data:
        model:
          provider: anthropic
          name: claude-3-5-sonnet-20241022
          mode: chat
          completion_params:
            temperature: 0.4
            max_tokens: 4000
        prompt_template:
          - role: system
            text: |
              ä½ æ˜¯ Dify å·¥ä½œæµæ¶æ„å¸ˆã€‚æ ¹æ®åˆ†æç»“æœè®¾è®¡å·¥ä½œæµçš„æ•´ä½“ç»“æ„ã€‚

              è®¾è®¡å†…å®¹ï¼š
              1. èŠ‚ç‚¹ç±»å‹å’Œæ•°é‡
              2. èŠ‚ç‚¹è¿æ¥å…³ç³»
              3. å˜é‡ä¼ é€’è·¯å¾„
              4. é”™è¯¯å¤„ç†ç­–ç•¥

              è¾“å‡ºæ ¼å¼ï¼š
              - æ¶æ„æ¦‚è¿°
              - èŠ‚ç‚¹æ¸…å•ï¼ˆç±»å‹ã€IDã€åŠŸèƒ½ï¼‰
              - æ•°æ®æµæè¿°
          - role: user
            text: |
              åŸºäºä»¥ä¸‹åˆ†æç»“æœè®¾è®¡å·¥ä½œæµæ¶æ„ï¼š

              {{#intent_analysis.text#}}

              åŸå§‹éœ€æ±‚ï¼š{{#start.requirement#}}

              è¯·æä¾›è¯¦ç»†çš„æ¶æ„è®¾è®¡ã€‚
        variables:
          - name: intent_analysis.text
            value_selector: ["intent_analysis", "text"]
          - name: start.requirement
            value_selector: ["start", "requirement"]

    # ---- èŠ‚ç‚¹å®ç°èŠ‚ç‚¹ ----
    - id: node_implementation
      type: llm
      title: èŠ‚ç‚¹å®ç°
      position:
        x: 550
        y: 400
      data:
        model:
          provider: anthropic
          name: claude-3-5-sonnet-20241022
          mode: chat
          completion_params:
            temperature: 0.3
            max_tokens: 6000
        prompt_template:
          - role: system
            text: |
              ä½ æ˜¯ Dify å·¥ä½œæµå®ç°ä¸“å®¶ã€‚æ ¹æ®æ¶æ„è®¾è®¡ç”Ÿæˆå®Œæ•´çš„ DSL YAMLã€‚

              å¿…é¡»éµå¾ªçš„è§„åˆ™ï¼š
              1. ä½¿ç”¨æœ‰æ•ˆçš„ Dify DSL 0.5.0 æ ¼å¼
              2. æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»æœ‰å”¯ä¸€çš„ ID
              3. ä½¿ç”¨æ­£ç¡®çš„å˜é‡å¼•ç”¨æ ¼å¼ {{#node_id.variable_name#}}
              4. åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼ˆposition, data ç­‰ï¼‰
              5. ç¡®ä¿èŠ‚ç‚¹è¿æ¥é¡ºåºåˆç†

              è¾“å‡ºæ ¼å¼ï¼š
              ç›´æ¥è¾“å‡ºå®Œæ•´çš„ YAMLï¼ˆä» app: å¼€å§‹ï¼‰ï¼Œä¸è¦æ·»åŠ  markdown ä»£ç å—æ ‡è®°ã€‚
          - role: user
            text: |
              æ ¹æ®ä»¥ä¸‹æ¶æ„è®¾è®¡ç”Ÿæˆå®Œæ•´çš„ Dify å·¥ä½œæµ YAMLï¼š

              æ¶æ„è®¾è®¡ï¼š
              {{#architecture_design.text#}}

              åŸå§‹éœ€æ±‚ï¼š
              {{#start.requirement#}}

              å·¥ä½œæµåç§°ï¼š{{#start.workflow_name#}}

              è¯·ç”Ÿæˆå®Œæ•´çš„ã€å¯ç›´æ¥å¯¼å…¥ Dify çš„ YAML æ–‡ä»¶å†…å®¹ã€‚
        variables:
          - name: architecture_design.text
            value_selector: ["architecture_design", "text"]
          - name: intent_analysis.text
            value_selector: ["intent_analysis", "text"]
          - name: start.requirement
            value_selector: ["start", "requirement"]
          - name: start.workflow_name
            value_selector: ["start", "workflow_name"]

    # ---- DSL éªŒè¯èŠ‚ç‚¹ ----
    - id: dsl_validation
      type: llm
      title: DSLéªŒè¯
      position:
        x: 800
        y: 300
      data:
        model:
          provider: anthropic
          name: claude-3-5-sonnet-20241022
          mode: chat
          completion_params:
            temperature: 0.2
            max_tokens: 4000
        prompt_template:
          - role: system
            text: |
              ä½ æ˜¯ Dify DSL éªŒè¯ä¸“å®¶ã€‚æ£€æŸ¥å¹¶ä¿®å¤ YAML ä¸­çš„é—®é¢˜ã€‚

              æ£€æŸ¥é¡¹ï¼š
              1. YAML è¯­æ³•æ­£ç¡®æ€§
              2. æ‰€æœ‰èŠ‚ç‚¹ ID å”¯ä¸€
              3. å˜é‡å¼•ç”¨æ ¼å¼æ­£ç¡®
              4. å¿…éœ€çš„èŠ‚ç‚¹å­—æ®µå®Œæ•´
              5. èŠ‚ç‚¹è¿æ¥é€»è¾‘åˆç†

              ä¿®å¤åŸåˆ™ï¼š
              - ä¿ç•™åŸå§‹è®¾è®¡æ„å›¾
              - åªä¿®å¤è¯­æ³•/æ ¼å¼é—®é¢˜
              - ä¸è¦æ”¹å˜åŠŸèƒ½é€»è¾‘

              è¾“å‡ºæ ¼å¼ï¼š
              ç›´æ¥è¾“å‡ºä¿®å¤åçš„å®Œæ•´ YAMLï¼ˆä» app: å¼€å§‹ï¼‰ã€‚
          - role: user
            text: |
              éªŒè¯å¹¶ä¿®å¤ä»¥ä¸‹ DSLï¼š

              {{#node_implementation.text#}}

              è¯·æ£€æŸ¥é—®é¢˜å¹¶è¿”å›ä¿®å¤åçš„ YAMLã€‚
        variables:
          - name: node_implementation.text
            value_selector: ["node_implementation", "text"]

    # ---- æ ¼å¼æ¸…ç†èŠ‚ç‚¹ ----
    - id: yaml_cleanup
      type: code
      title: YAMLæ¸…ç†
      position:
        x: 1050
        y: 300
      data:
        code_language: python3
        code: |
          import re

          def main(yaml_text: str) -> dict:
              # æå– YAML å†…å®¹ï¼ˆç§»é™¤å¯èƒ½çš„ markdown ä»£ç å—ï¼‰
              text = yaml_text.strip()
              
              # ç§»é™¤ markdown ä»£ç å—æ ‡è®°
              if text.startswith('```yaml'):
                  text = text[7:]
              elif text.startswith('```yml'):
                  text = text[6:]
              elif text.startswith('```'):
                  text = text[3:]
              
              if text.endswith('```'):
                  text = text[:-3]
              
              text = text.strip()
              
              # ç¡®ä¿ä»¥ app: å¼€å¤´
              if not text.startswith('app:'):
                  # å°è¯•æ‰¾åˆ° app: çš„ä½ç½®
                  match = re.search(r'\napp:', text)
                  if match:
                      text = text[match.start() + 1:]
              
              return {
                  "clean_yaml": text,
                  "ready_for_export": text.startswith('app:') or text.startswith('workflow:')
              }
        inputs:
          - name: yaml_text
            value_selector: ["dsl_validation", "text"]
        outputs:
          - name: clean_yaml
            type: string
          - name: ready_for_export
            type: boolean

    # ---- æ–‡æ¡£ç”ŸæˆèŠ‚ç‚¹ ----
    - id: doc_generation
      type: llm
      title: ç”Ÿæˆæ–‡æ¡£
      position:
        x: 800
        y: 500
      data:
        model:
          provider: anthropic
          name: claude-3-5-sonnet-20241022
          mode: chat
          completion_params:
            temperature: 0.5
            max_tokens: 3000
        prompt_template:
          - role: system
            text: |
              ä½ æ˜¯æŠ€æœ¯æ–‡æ¡£ç¼–å†™ä¸“å®¶ã€‚ä¸ºç”Ÿæˆçš„å·¥ä½œæµç¼–å†™ä½¿ç”¨è¯´æ˜ã€‚

              æ–‡æ¡£å†…å®¹ï¼š
              1. å·¥ä½œæµåŠŸèƒ½æ¦‚è¿°
              2. è¾“å…¥å‚æ•°è¯´æ˜
              3. ä½¿ç”¨æ­¥éª¤
              4. ç¤ºä¾‹è¾“å…¥
              5. æ³¨æ„äº‹é¡¹

              è¾“å‡ºæ ¼å¼ï¼šMarkdown
          - role: user
            text: |
              ä¸ºä»¥ä¸‹å·¥ä½œæµç”Ÿæˆæ–‡æ¡£ï¼š

              åŸå§‹éœ€æ±‚ï¼š{{#start.requirement#}}

              æ„å›¾åˆ†æï¼š{{#intent_analysis.text#}}

              è¯·æä¾›ç®€æ´æ˜äº†çš„ä½¿ç”¨æ–‡æ¡£ã€‚
        variables:
          - name: start.requirement
            value_selector: ["start", "requirement"]
          - name: intent_analysis.text
            value_selector: ["intent_analysis", "text"]

    # ---- æœ€ç»ˆè¾“å‡ºèŠ‚ç‚¹ ----
    - id: final_output
      type: template
      title: æœ€ç»ˆè¾“å‡º
      position:
        x: 1300
        y: 300
      data:
        template: |
          # ç”Ÿæˆçš„å·¥ä½œæµ

          ## ä½¿ç”¨è¯´æ˜
          {{#doc_generation.text#}}

          ---

          ## å¯¼å‡ºçš„ YAMLï¼ˆå¯ç›´æ¥å¤åˆ¶åˆ° Difyï¼‰

          ```yaml
          {{#yaml_cleanup.clean_yaml#}}
          ```

          ---

          ## å¯¼å…¥æ­¥éª¤
          1. å¤åˆ¶ä¸Šæ–¹ YAML å†…å®¹
          2. åœ¨ Dify ä¸­é€‰æ‹© "å¯¼å…¥ DSL æ–‡ä»¶"
          3. ç²˜è´´ YAML å†…å®¹
          4. ç‚¹å‡»ç¡®è®¤å¯¼å…¥

          **çŠ¶æ€**: {{#yaml_cleanup.ready_for_export??ç”ŸæˆæˆåŠŸ:å¯å¯¼å…¥âœ…:éœ€è¦æ£€æŸ¥âš ï¸#}}
        variables:
          - name: doc_generation.text
            value_selector: ["doc_generation", "text"]
          - name: yaml_cleanup.clean_yaml
            value_selector: ["yaml_cleanup", "clean_yaml"]
          - name: yaml_cleanup.ready_for_export
            value_selector: ["yaml_cleanup", "ready_for_export"]

    # ---- ç»“æŸèŠ‚ç‚¹ ----
    - id: end
      type: end
      title: ç»“æŸ
      position:
        x: 1550
        y: 300
      data:
        outputs:
          - name: generated_workflow
            value_selector: ["yaml_cleanup", "clean_yaml"]
            description: ç”Ÿæˆçš„å·¥ä½œæµ YAML
          - name: documentation
            value_selector: ["doc_generation", "text"]
            description: ä½¿ç”¨æ–‡æ¡£
          - name: export_ready
            value_selector: ["yaml_cleanup", "ready_for_export"]
            description: æ˜¯å¦å¯å¯¼å‡º

  # ========== èŠ‚ç‚¹è¿æ¥ ==========
  edges:
    - id: start_to_intent
      source: start
      target: intent_analysis
      type: direct

    - id: intent_to_arch
      source: intent_analysis
      target: architecture_design
      type: direct

    - id: intent_to_impl
      source: intent_analysis
      target: node_implementation
      type: direct

    - id: arch_to_impl
      source: architecture_design
      target: node_implementation
      type: direct

    - id: impl_to_validation
      source: node_implementation
      target: dsl_validation
      type: direct

    - id: validation_to_cleanup
      source: dsl_validation
      target: yaml_cleanup
      type: direct

    - id: cleanup_to_output
      source: yaml_cleanup
      target: final_output
      type: direct

    - id: impl_to_doc
      source: node_implementation
      target: doc_generation
      type: direct

    - id: intent_to_doc
      source: intent_analysis
      target: doc_generation
      type: direct

    - id: doc_to_output
      source: doc_generation
      target: final_output
      type: direct

    - id: output_to_end
      source: final_output
      target: end
      type: direct

  environment_variables: []
  conversation_variables: []
